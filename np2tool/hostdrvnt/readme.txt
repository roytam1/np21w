■■■ Neko Project II ホスト共有ドライブドライバ for WinNT ■■■

Windows NT系からNeko Project IIのホスト共有ドライブにアクセスするためのデバイス
ドライバです。エミュレータ内のOSからホストPCの指定フォルダにアクセスできます。
HOSTDRV.COMのWindows NT版です。ロングファイルネームにも対応しています。

【注意！！】
Neko Project IIのバグやゲストOSの暴走が発生した場合、その影響がホストのファイル
にも及ぶことになりますので、共有範囲とアクセス権限は必要最小限にとどめる事を
おすすめします（少なくとも共有範囲外は安全です）。
本機能を使用してファイルが消失した場合でも、作者は責任を負いません。
そのことに同意頂けない場合は使用しないでください。


●動作環境
【ゲスト】
Windows NT3.51, NT4.0, 2000
【ホスト】
Neko Project 21/W ver0.86 rev94β10以降
設定でHostdrvおよびHostdrv for NTを有効にしている環境（INI設定も可）


●インストール
ドライバをゲストOSにインストールして使用します。
・Windows NT4.0, 2000の場合
レガシードライバ扱いでインストールします。
hostdrv.infを右クリック→インストール
でインストールできます。
アップデートも同じ操作でできますが、反映にはシステムの再起動が必要です。
ほか、付属のregファイルをインポートしてもインストールできます。

・Windows NT3.51の場合
hostdrv.inf内に記載の[NP2HostDrive.AddReg]セクションの内容を参考に、
regedt32を使用して手動で打ち込んでください。


●アンインストール
・Windows NT3.51, NT4.0の場合
コントロールパネル→デバイスでNeko Project II Host Driveのスタートアップを
無効にしてください。完璧に消したい場合、レジストリエディタで
HKLM\System\CurrentControlSet\Services\hostdrv
を消してください。
ファイルも消したい場合は
System32\drivers\hostdrv.sys
System32\hdrvmnt.exe
を消してください。

・Windows 2000の場合
デバイスマネージャ→表示→非表示のデバイスの表示
でプラグアンドプレイではないドライバを表示させ、
Neko Project II Host Driveを削除してください。
上手く消えない場合はWindows NT3.51, NT4.0の場合と同じ手順で削除してください。


●使い方
ver.1.5から自動マウントがデフォルトで有効になりました。
手動マウントにしたい場合は、
HKLM\System\CurrentControlSet\Services\hostdrv
の中にあるAutoMountを0にしてください。

手動マウントにした場合は、システムに登録されたhdrvmnt.exeを使用してドライブ
文字を割り当てます。
①np2のiniにUSEHDRVN=trueを書いて下さい。
②np2本体の共有フォルダ設定を実施して下さい。
（np21/wならDevice->Hostdrv Optionで設定可能）
③HOSTDRV.COMと同様に、hdrvmnt.exeをドライブ文字を付けて実行してください。

　hdrvmnt ドライブ文字(A～Z)

起動時に自動で割り当てたい場合は、次の「追加設定」を参照してください。
なお、Win2000でドライブに×マークが付けられますが、普通にアクセスできます
ので気にしないで下さい。
気になる人はこのドキュメントの最後の方にあるおまけの項目を参照してください。


●追加設定
HKLM\System\CurrentControlSet\Services\hostdrv
へ以下の値を追加すると挙動を変更できます（要再起動）。

○IsDiskDevice
DWORD値を1にすると、ネットワークドライブではなく普通のディスクドライブとして
認識させます。

○IsRemovableDevice
DWORD値を1にすると、ネットワークドライブではなくリムーバブルドライブとして
認識させます。IsDiskDeviceよりもこちらのフラグが優先されます。

○UseRealCapacity
DWORD値を1にすると、仮想的な容量ではなくホストのディスクの実容量を返します。

○UseCheckNotify
DWORD値を1にすると、ホストでのファイル変更をゲストOSに通知します。
エクスプローラなどで表示更新（F5）をせずにホストでのファイル追加削除が
反映されますが、ポーリング処理のため負荷が増加します。

○CheckNotifyInterval
UseCheckNotify=1のとき、ポーリング間隔（秒）をDWORD値で指定します。
最小は1秒、最大は60秒です。

○AutoMount
DWORD値を1にすると、ドライバのロード時に自動的にドライブ文字を割り当てます。
このオプションを有効にするとhdrvmntは使用できません（挙動が変になります）。

○AutoMountDriveLetter
AutoMount=1のとき、ドライバのロード時に自動的割り当てるドライブ文字を
REG_SZで指定します。ドライブ文字はA～Zの1文字で指定して下さい（:は付けない）。
"Auto"または無効値の場合は、Zから順にY,X,W,...と空きを探します。


●ソースコード
np21/wソースのnp2tool\hostdrvntにソースコードがあります。
全て猫本体と同じ修正BSDライセンスとしますが、実質的に自由に使っていただいて
大丈夫です。煮るなり焼くなり切り貼りするなり自由にしてください。


●安全に使うためのヒント
Neko Project 21/WのHostdrv設定で、アクセス権限を外すとその操作を禁止できます。
たとえばWRITEやDELETE権限を消しておけば、ゲストOS暴走で勝手に書き換えられたり
消されたりする被害を防止できます（作者は今のところは出くわしたことはないです）。
また、Hostdrv設定で共有するパス部分を含まない場所へはアクセスできない仕様に
なっています。したがって、Hostdrv設定で共有するパスは必要最小限に範囲にする方
が安全です。
例外として、共有している場所にNTFSシンボリックリンクが置かれている場合、
そのシンボリックリンクの先へはアクセスできてしまいます。
共有している場所に予期しないシンボリックリンクが含まれないようにしてください。
なお、ゲストOSからはシンボリックリンクを作成出来ない仕様ですので、その点は
ご安心ください。


●おまけ
Windows 2000ではネットワークドライブにすると赤色の×マークが付けられます。
これが気に入らない場合は対症療法としてレジストリを使ってドライブアイコンの
置き換えが可能です。具体的には以下のキーに設定を行います。

【やり方】
HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\DriveIcons\Z\DefaultIcon
のデフォルト値に"%SystemRoot%\System32\shell32.dll,9"を足す。

この場合、Zドライブのアイコンを強制的にshell32.dllのアイコン9番に変更します。
付属させているdriveico.regはZドライブ決め打ちでこの設定を行います。
ただし、Zドライブに何があっても問答無用でネットワークドライブのアイコンになり
ます。元に戻したい場合はZ以下のキーを削除して再起動してください。


------------------------
Neko Project 21/W 開発者
SimK
