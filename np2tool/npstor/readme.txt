■■■ Neko Project II 専用SCSIコントローラドライバ for Windows ■■■

Windowsで使用出来るNeko Project II 専用SCSIコントローラドライバです。
DMAのような仕組みで動くため、標準IDEドライバと比べると非常に高速です。

●動作環境
【ゲスト】
Windows 95, 98, 98SE, NT3.51, NT4.0, 2000
【ホスト】
Neko Project 21/W ver0.86 rev95β3以降
SCSI互換のCHSを持つディスクをSCSIディスクとしてマウントしている環境
※SCSIではHが15までな点に特に注意してください
※ドライバはWin95, 98, 98SE, 2000用とWinNT4.0, 3.51用に分かれています

●インストール
・Windows 95, 98, 98SEの場合
セットアップ時はDOS互換モードで動きます。Windowsのセットアップが完了した後で
npstor.hdmを挿入し、ハードウェアウィザードでnpstor.infを指定してインストール
してください。

・Windows 2000の場合
【セットアップ時に使う場合】
セットアップ開始時にF6キーでドライバを読み込ませます。
画面が出たらSキーを押してnpstor.hdmを挿入してください。
【セットアップ後に使う場合】
npstor.hdmを挿入しハードウェアの追加と削除でnpstor.infを指定してインストール
してください。

・Windows NT4.0の場合
【セットアップ時に使う場合】
セットアップ途中にドライバを読み込ませます。
画面が出たらSキーを押してwnt\npstornt.hdmを挿入してください。
【セットアップ後に使う場合】
wnt\npstornt.hdmを挿入しコントロールパネルのSCSIアダプタでnpstor.infを指定して
インストールしてください。

・Windows NT3.51の場合
【セットアップ時に使う場合】
セットアップ途中にドライバを読み込ませます。
画面が出たらSキーを押してwnt\npstornt.hdmを挿入してください。
【セットアップ後に使う場合】
メインのWindows NTセットアップを開き、設定メニューのSCSIアダプタの追加と削除を
選択し、wnt\npstornt.hdmを挿入してドライバをインストールしてください。


●ソースコード
srcフォルダにソースコードがあります。
猫SCSIの使い方については、np21wソースのcbus\scsiio.cも参照してください。
いちおう猫本体と同じ修正BSDライセンスとしますが、実質的に自由に使っていただいて大丈夫です。
【この仕様に従って独自ドライバを書きたい場合の注意】
Win2000のEBDファイル埋め尽くし対策として、約20MB書き込む毎にBUSYを返します。
BUSYが返ってきた場合何も気にせずにリトライすれば成功します。
（この仕様が嫌な場合、NP2STOR_INVOKEINFOのcmdを1にしてください）
また、渡すアドレスはページング有効なら仮想メモリアドレスです。
この際、渡したアドレスでページフォールトが起こらないようにしてください。
なお、np2w（286リアルモード限定版）ではサポートしていません。


●猫SCSI仕様
猫SCSIは完全にエミュレータを前提とした方法で動作します。
以下の手順で入出力データを用意し、特定のI/Oポートに値を書き込むと、np2本体が
仮想マシンの処理を奪い取って代わりにデータを読み書きし、再度仮想マシンに制御を
戻します。したがって、仮想マシン内からはI/Oポートに書き込んだ瞬間にデータが処理
されたように見えます。
①NP2STOR_INVOKEINFO構造体を仮想メモリ（非ページプール）に確保し、必要な情報を
書き込みます。データ構造はnp21wソースのcbus\scsiio.cを参照してください。
typedef struct
{
	UINT32 version; // バージョン 今のところ1のみ
	UINT32 cmd; // コマンド NP2STOR_INVOKECMD_xxx　cbus\scsiio.cを参照
	SCSI_REQUEST_BLOCK *srb; // SCSI_REQUEST_BLOCKへの仮想メモリアドレス
} NP2STOR_INVOKEINFO;
このうちsrbには、WindowsNTのSCSIミニポートドライバのSCSI_REQUEST_BLOCK構造体
への仮想メモリアドレスを格納します。
一部しか使用していませんので全てを真面目に埋める必要はありません。
何を使用しているのかの詳細はnp21wソースのcbus\scsiio.cを参照してください。
大雑把には、Functionに実行するミニポート機能、CdbにSCSIコマンドの中身、
DataBufferに入出力バッファへのアドレス、DataTransferLengthにバッファサイズ
（制御が返った後は戻り値データサイズ）、SrbStatusにステータスがあります。
②上記NP2STOR_INVOKEINFO構造体の仮想メモリアドレスをI/Oポート7EAhへ書き込み、
I/Oポート7EBhに0x98→0x01の順で書き込むと猫本体が処理を実行します。
③渡した構造体のsrb->SrbStatusを見て成否を判断します。
SCSIOP_WRITE時の返事がSRB_STATUS_BUSYの場合は何も考えずにリトライでOKです。

【注意事項】上記のメモリは全て非ページプールに確保してください。
渡したメモリ領域がページアウトしていると正しく動かないと思います。
また、ページング無効状態の場合は物理メモリアドレスを渡してください。


●更新履歴
2025/07/04 ver.1.0 初版
2025/07/22 ver.1.1 Windows 9x系に対応

------------------------
Neko Project 21/W 開発者
SimK
